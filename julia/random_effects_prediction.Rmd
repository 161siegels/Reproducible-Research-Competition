---
title: "Untitled"
author: "Spencer Siegel"
date: "7/31/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if(!require(knitr)) {install.packages("knitr", repos="http://cran.us.r-project.org"); library(knitr)}
knitr::opts_chunk$set(echo = FALSE)
if(!require(dplyr)) {install.packages("dplyr", repos="http://cran.us.r-project.org"); library(dplyr)}
if(!require(tidyverse)) {install.packages("tidyverse", repos="http://cran.us.r-project.org"); library(tidyverse)}
if(!require(zoo)) {install.packages("zoo", repos="http://cran.us.r-project.org"); library(zoo)}
if(!require(data.table)) {install.packages("data.table", repos="http://cran.us.r-project.org"); library(data.table)}
if(!require(MASS)) {install.packages("MASS", repos="http://cran.us.r-project.org"); library(MASS)}
if(!require(randomForest)) {install.packages("randomForest", repos="http://cran.us.r-project.org"); library(randomForest)}
if(!require(Ckmeans.1d.dp)) {install.packages("Ckmeans.1d.dp", repos="http://cran.us.r-project.org"); library(Ckmeans.1d.dp)}
if(!require(DAAG)) {install.packages("DAAG", repos="http://cran.us.r-project.org"); library(DAAG)}
if(!require(e1071)) {install.packages("e1071", repos="http://cran.us.r-project.org"); library(e1071)}
if(!require(splines)) {install.packages("splines", repos="http://cran.us.r-project.org"); library(splines)}
if(!require(readr)) {install.packages("readr", repos="http://cran.us.r-project.org"); library(readr)}
if(!require(class)) {install.packages("class", repos="http://cran.us.r-project.org"); library(class)}
if(!require(xgboost)) {install.packages("xgboost", repos="http://cran.us.r-project.org"); library(xgboost)}
if(!require(mlr)) {install.packages("mlr", repos="http://cran.us.r-project.org"); library(mlr)}
if(!require(parallelMap)) {install.packages("parallelMap", repos="http://cran.us.r-project.org"); library(parallelMap)}
if(!require(parallel)) {install.packages("parallel", repos="http://cran.us.r-project.org"); library(parallel)}
if(!require(cluster)) {install.packages("cluster", repos="http://cran.us.r-project.org"); library(cluster)}
if(!require(factoextra)) {install.packages("factoextra", repos="http://cran.us.r-project.org"); library(factoextra)}
if(!require(gridExtra)) {install.packages("gridExtra", repos="http://cran.us.r-project.org"); library(gridExtra)}
if(!require(cluster)) {install.packages("cluster", repos="http://cran.us.r-project.org"); library(cluster)}
if(!require(mclust)) library(mclust)
library(gridExtra)
library(caret)
```

```{r}
temp=read.csv("with_clusters2.csv")
train<-temp%>% group_by(Person1) %>% sample_frac(.7)
test = anti_join(temp, train) 
train

```



## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
train<-read.csv("train1.csv")
test =read.csv("test1.csv")
fix<-read.csv('fixed_effects_fixed.csv')
re<-read.csv('random_effects_fixed.csv')
```

```{r}
fix
pred=rep(fix[1,3],18824)+fix[2,3]*test$past_FG_percent+fix[3,3]*test$past_Free_Throw_percent+fix[4,3]*test$past_Free_Throw_percent
1/(exp(-pred)+1)
exp(pred)/(1+exp(pred))

re

colnames(re)[2:54]
product2=NULL

test=test%>%dplyr::select(Layup,Dunk,Hook,Fadeaway,Floating,Pullup,Step_Back,Running,Driving,Cutting,Reverse,Alley_Oop,Finger_Roll,Putback,Turnaround,Bank,point_dif,Tip,cd1,cd2,cd3,cd4,cd5,cd6,TOUCH_TIME,DRIBBLES,d1,d2,d3,d4,d5,d7,d8,d9,d10,d11,d12,ratio,Jump_Shot,Team_id_type,End_SC,End_PC,Option1,Play_Loc_sd,Play_Loc_fd,Opp_Team_Def_Rtg,Quick_S,Clutch_T,Garbage_T,PC_Time,SHOT_CLOCK,shot_num,Person1,Shot_Outcome)

test$Intercept=1

test$Intercept
test=test[,c(55,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54)]

for(i in 1:nrow(re)){
  rows=NULL
  mat=as.matrix(test[which(test$Person1==re$X[i]),1:53])
  vec=as.vector(re[i,2:54],mode='numeric')
  rows<-sweep(mat, MARGIN=2, vec, `*`)
  names(product2) <- names(rows) 
  rows<-cbind(rows,test[which(test$Person1==re$X[i]),3])
  product2<-rbind(product2,rows)
}

product2<-as.data.frame(product2)

finalpred=rowSums(product2)+pred
1/(exp(-finalpred)+1)

pred2<-ifelse(finalpred>0.5,1,0)
accuracy<-sum(pred2==test$Shot_Outcome)/nrow(test)

accuracy
conf_matrix<-table(pred2,test[, "Shot_Outcome"])
sensitivity(conf_matrix)
specificity(conf_matrix)

```

